{% extends 'layouts/base_1.html' %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="text-center">Estado de Solicitudes de Permisos Realizadas por el Estudiante</h1>
        </div>
        <div class="text-center col-md-64">
            <table class="table">
                <thead>
                    <tr>
                        <th>Materia(s)</th>
                        <th>Estado del (de los) Permiso(s) Solicitado(s)</th>
                        <th>Fecha en la que se Realiza la Solicitud</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for id_solicitud, permisos in grouped_permisos.items %}
                    <tr>
                        <td>
                            <button type="button" class="btn btn-primary toggle-button" onclick="toggleMaterias(this)">
                                Ver Materias
                            </button>
                        </td>
                        
                        <script>
                            var popoverDiv; // Variable global para mantener la referencia al popover
                        
                            function toggleMaterias(btn) {
                                // Cerrar el popover si ya está abierto
                                if (popoverDiv) {
                                    popoverDiv.remove();
                                    popoverDiv = null;
                                    return;
                                }
                        
                                // Obtener el contenedor de materias
                                var materiasContent = '{% for permiso in permisos %}- {{ permiso.materia }}<br>{% endfor %}';
                        
                                // Crear un div para el popover
                                popoverDiv = document.createElement('div');
                                popoverDiv.className = 'custom-popover';
                                popoverDiv.innerHTML = `
                                    <div class="popover-header">
                                        <h6 class="popover-title">Tus Materias</h6>
                                    </div>
                                    <div class="popover-body" style="background-color: white; padding: 10px;">
                                        ${materiasContent}
                                    </div>
                                `;
                        
                                // Posicionar el popover al lado del botón
                                var rect = btn.getBoundingClientRect();
                                popoverDiv.style.position = 'absolute';
                                popoverDiv.style.top = rect.top + 'px';
                                popoverDiv.style.left = rect.right + 'px';
                        
                                // Agregar el popover al body
                                document.body.appendChild(popoverDiv);
                        
                                // Agregar un manejador de clic fuera del popover para cerrarlo
                                document.addEventListener('click', function (e) {
                                    if (!popoverDiv.contains(e.target) && e.target !== btn) {
                                        popoverDiv.remove();
                                        popoverDiv = null;
                                        document.removeEventListener('click', arguments.callee);
                                    }
                                });
                            }
                        </script>                                                                
                        <td
                            class="{% if permisos.0.estado == 'Aceptado' %}table-success{% elif permisos.0.estado == 'Rechazado' %}table-danger{% elif permisos.0.estado == 'Pendiente' %}table-warning{% elif permisos.0.estado == 'Observado' %}table-info{% endif %}">
                            <strong>{{ permisos.0.estado }}</strong>

                            {% if permisos.0.estado == 'Aceptado' %}
                            <div class="text-black" style="white-space: pre-line;">La solicitud cuenta con los
                                requisitos necesarios para ser considerada válida por Dirección de Carrera.</div>
                            {% elif permisos.0.estado == 'Rechazado' %}
                            <div class="text-black" style="white-space: pre-line;">La solicitud no cuenta con los
                                requisitos necesarios para ser considerada válida por Dirección de Carrera.</div>
                            {% elif permisos.0.estado == 'Observado' %}
                            <div class="text-black" style="white-space: pre-line;">La solicitud fue observada y se deja
                                a consideración del docente de la materia el aceptar o rechazar la solicitud.
                            </div>
                            <button class="btn btn-primary toggle-button">Añadir</button>
                            {% endif %}
                        </td>

                        <td>{{ permisos.0.fechaSolicitud }}</td>
                        <td>{{ permisos.0.observaciones }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll(".toggle-button");

        toggleButtons.forEach(button => {
            button.addEventListener("click", function () {
                const targetId = this.getAttribute("data-target");
                const targetContainer = document.getElementById(targetId);

                if (targetContainer.style.display === "none" || targetContainer.style.display === "") {
                    targetContainer.style.display = "block";
                } else {
                    targetContainer.style.display = "none";
                }
            });
        });
    });
</script>
{% endblock %}